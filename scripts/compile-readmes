#!/bin/sh -e

compile_readme() {
    package_readme="$1"
    code_readme="$2"

    echo "Compiling $code_readme to $package_readme"

    header_comment="<!-- This file is compiled from $code_readme. Do not edit this file directly. -->\n"

    # Copy bolt/bolt/README.md to bolt/README.md and add a header comment
    echo "$header_comment" > "$package_readme"
    cat "$code_readme" >> "$package_readme"

    code_base_dir=$(dirname "$code_readme")

    # Find and replace any "](./" markdown links and replace with a full github.com url
    docs_url="https://boltframework.dev/docs"
    sed -i '' -e "s#](\./\([^)]*\))#]($docs_url/$code_base_dir/\1)#g" "$package_readme"
}

compile_readme "bolt/README.md" "bolt/bolt/README.md"

# Now do the same for every bolt-* package and the README.md found at bolt-<pkg>/bolt/*/README.md
for package_dir in bolt-*; do
    # if [ -d "$package_dir/bolt" ]; then
    # Find the README.md in $package_dir/bolt/*/README.md
    find "$package_dir/bolt" -name "README.md" | while read -r code_readme; do
        package_readme="$package_dir/README.md"
        compile_readme "$package_readme" "$code_readme"
    done
    # compile_readme "$package_dir/README.md" "$package_dir/bolt/README.md"
    # fi
done
